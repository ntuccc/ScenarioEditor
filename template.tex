% !TEX TS-program = XeLaTeX+MakeIndex+BibTeX
\documentclass{article}
\usepackage{xeCJK}
\usepackage[a5paper, margin = 1.27cm, footskip = 1cm, headsep = 10pt, includefoot]{geometry}
\usepackage{setspace}
\usepackage{fancyhdr}
\usepackage{graphicx}
\usepackage{adjustbox}
\usepackage{xifthen}
\usepackage{enumitem}
\usepackage{calc}
\usepackage[most]{tcolorbox}
\usepackage{tabularx}
\usepackage{ltablex}
\usepackage{makecell}
\usepackage{expl3}
\usepackage{xparse}
\usepackage{xassoccnt}

\keepXColumns

\setmainfont{新細明體}[AutoFakeBold, Mapping = ]
\setCJKmainfont{新細明體}

\xeCJKDeclarePunctStyle {mypunctstyle} {
	enabled-kerning = false
}
\xeCJKsetup{PunctStyle = mypunctstyle}

\newfontfamily\calibri{Calibri}

%\renewcommand{\baselinestretch}{1.5}

\fancypagestyle{mystyle}{
	\renewcommand{\headrulewidth}{0pt}
	\fancyfoot[C]{\calibri \thepage}
}

\pagestyle{mystyle}

\newcommand{\oneline}[1]{%
	\newdimen{\namewidth}%
	\setlength{\namewidth}{\widthof{#1}}%
	\ifthenelse{\lengthtest{\namewidth < \textwidth}}%
	{#1}% do nothing if shorter than text width
	{\resizebox{\textwidth}{!}{#1}}% scale down
}

\newtcolorbox{myfigure}[1][]{height fill, space to=\myspace, #1}
\newtcolorbox{myfigures}{width = \textwidth, height = 0.5\textheight, blanker}

\ExplSyntaxOn
\str_new:N \l_param_str
\newenvironment{sentence}[1]
{
	\str_set:Nn \l_param_str {#1}
	\str_if_empty:NTF \l_param_str
		{\begin{description}[style = unboxed, labelsep = 0pt, nosep, leftmargin = 0pt] \item[]}
		{\begin{description}[style = unboxed, labelsep = 0pt, nosep, leftmargin = \widthof{#1：}] \item[#1：]}
}
{
	\end{description}
}
\ExplSyntaxOff

\newcolumntype{Y}{>{\centering\arraybackslash}X}
%\renewcommand{\tabularxcolumn}[1]{m{#1}}

\newcounter{realpage}
\DeclareAssociatedCounters{page}{realpage}
\AtBeginDocument{%
	\stepcounter{realpage}
}

\ExplSyntaxOn
\newlength\wordwidth
\newlength\wordheight
\int_new:N \l_linewords_int
\str_new:N \l_printbar_str
\cs_new:Npn \bartext #1 {
	\setlength\wordwidth{\widthof{#1}}
	\int_set:Nn \l_linewords_int {\int_div_truncate:nn {\dim_to_decimal_in_sp:n {\textwidth}} {\dim_to_decimal_in_sp:n {\wordwidth}} }
	\str_clear:N \l_printbar_str
	\int_step_inline:nn {\l_linewords_int}{
		\str_put_right:Nn \l_printbar_str {#1}
	}
	\str_use:N \l_printbar_str
}
\NewDocumentCommand{\ruleline}{O{}}{
	\str_set:Nn \l_param_str {#1}
	\str_if_empty:NTF \l_param_str
	{
		\setlength\wordheight{\heightof{我}} %dummy word
		\raisebox {0.5\wordheight} {
			\makebox[\linewidth]{\hrulefill}
		}
	}{
		\setlength\wordheight{\heightof{#1}}
		\raisebox {0.5\wordheight} {
			\makebox[\linewidth]{\hrulefill \raisebox{-0.5\wordheight}{#1} \hrulefill}
		}
	}
}
\seq_new:N \l_images_seq
\int_new:N \l_pageremfour_int
\int_new:N \l_image_to_insert_int
\NewDocumentCommand{\picturepadding}{m}{
	\seq_set_split:Nnn \l_images_seq {,} {#1}
	\seq_remove_all:Nn \l_images_seq {} %remove empty items
	\int_set:Nn \l_pageremfour_int {\int_mod:nn {\value{realpage}} {4}}
	\int_compare:nNnTF {\l_pageremfour_int} = {0} {
		\dim_compare:nNnTF {\textheight - \pagetotal} < {0.5\textheight}{
			\int_set:Nn \l_image_to_insert_int {0}
		}{
			\int_set:Nn \l_image_to_insert_int {1}
		}
	}{
		\dim_compare:nNnTF {\textheight - \pagetotal} < {0.5\textheight}{
			\int_set:Nn \l_image_to_insert_int {(4 - \l_pageremfour_int) * 2}
		}{
			\int_set:Nn \l_image_to_insert_int {(4 - \l_pageremfour_int) * 2 + 1}
		}
	}
	\seq_map_inline:Nn \l_images_seq {
		\int_compare:nNnTF {\l_image_to_insert_int} = {0} {\seq_map_break:} {}
		\int_compare:nNnTF {\int_mod:nn {\l_image_to_insert_int} {2}} = {0} {
			\newpage
			\begin{figure}[t]
			\centering
			\adjustimage{max~width = \textwidth, max~height = 0.5\textheight, keepaspectratio}{##1}
			\end{figure}
		}{
			\begin{figure}[b]
			\centering
			\adjustimage{max~width = \textwidth, max~height = 0.5\textheight, keepaspectratio}{##1}
			\end{figure}
		}
		\int_decr:N \l_image_to_insert_int
	}
}
\ExplSyntaxOff


\begin{document}
\setstretch{1.5}
\setlength{\parindent}{0pt}

\vspace*{0mm}%
\vspace{-\parskip}
\vspace{-2\baselineskip} %twice hack to match the size I like

\begin{center}
{\fontsize{16pt}{24pt}\selectfont
	\textbf{
		%{{ scenario.other_info['index'] }}
	} \\
	%{{ scenario.other_info['date'] }} \\
	\oneline{
		%{{ scenario.title }}
	}
\par}
\end{center}

\begin{myfigure}[blanker]
%{% if scenario.other_info['image']|length == 0 %}
%{% else %}\centering \includegraphics[width=\linewidth, height=\myspace, keepaspectratio]{%{{ scenario.other_info['image'] }}}
%{%- endif %}
\end{myfigure}

%\setstretch{1.0}
%{% for handler in scenario.handlers() %}
%{%- if scenario.dialogue[handler]['speaker'] in scenario.character %}\begin{sentence}{%{{ scenario.character[scenario.dialogue[handler]['speaker']]['abbreviated'] }}}
%{%- elif scenario.dialogue[handler]['speaker']|length > 0 %}\begin{sentence}{%{{ scenario.dialogue[handler]['speaker'] }}}
%{%- else %}\begin{sentence}{}%{% endif %}
%{{ scenario.dialogue[handler]['text'] }}
%{# #}\end{sentence}

%{% endfor %}

\ExplSyntaxOn
\dim_compare:nNnTF {\textheight - \pagetotal} < {\textheight / 7} {\newpage} {\mbox{}\\}
\ExplSyntaxOff
ＣＡＳＴ
{
\fontsize{11}{11}\selectfont
\setcellgapes{1pt} \makegapedcells
\begin{tabularx}{\textwidth}{|Y|Y|Y|}
\hline
%{% for name, info in scenario.character.items()|sort(attribute = '1.order') %}
%{{ name }}{\calibri (}%{{ info['abbreviated'] }}{\calibri )} & %{{ info['gender'] }} & \\ \hline
%{% endfor %}
\end{tabularx}
}
%\bartext{─} \\
%\bartext{我}
%\the\wordheight
%\the\pagetotal
\picturepadding{
	%{{ scenario.other_info['imagelist'] }}
}
\end{document}